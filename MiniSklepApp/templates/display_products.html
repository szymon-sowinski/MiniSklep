<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista produktów</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Lista produktów</h2>
            <div>
                <a href="{% url 'add_product' %}" class="btn btn-info">Dodaj produkt</a>
                {% if request.user.is_authenticated %}
                    <a href="{% url 'logout' %}" class="btn btn-danger">Wyloguj się</a>
                {% else %}
                    <button class="btn btn-danger" disabled>Wyloguj się</button>
                {% endif %}
            </div>
        </div>

        {% if message %}
        <div class="alert alert-success alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="card p-3 shadow-sm">
            <div class="d-flex justify-content-between mb-3">
                <button id="delete-selected" class="btn btn-danger" disabled>Usuń zaznaczone</button>
                <form action="{% url 'delete_all_products' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Usuń wszystkie</button> 
                </form>
            </div>
            
            <table class="table table-striped table-hover table-fixed">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th class="w-75">Nazwa produktu</th> 
                        <th class="w-25">Cena</th>
                        <th class="w-25">Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr data-id="{{ product.id }}">
                        <td><input type="checkbox" class="row-checkbox"></td>
                        <td contenteditable="true" class="editable w-60" data-field="name">{{ product.name }}</td>
                        <td contenteditable="true" class="editable w-15" data-field="price">{{ product.price }} zł</td>
                        <td class="w-25">
                             <a href="{% url 'delete_product' product.id %}" class="btn btn-danger">Usuń</a>
                         </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>            
    </div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".editable").forEach(cell => {
            cell.addEventListener("blur", function () {
                let row = this.closest("tr");
                let productId = row.getAttribute("data-id");
                let field = this.getAttribute("data-field");
                let value = this.innerText.replace(" zł", "");
    
                let formData = new FormData();
                formData.append("id", productId);
                formData.append("field", field);
                formData.append("value", value);
    
                fetch("{% url 'update_product' %}", {
                    method: "POST",
                    body: formData
                }).then(response => response.text())
                  .then(data => {
                      if (data !== "success") {
                          alert("Błąd podczas zapisu!");
                      }
                  });
            });
        });

        const deleteButton = document.getElementById("delete-selected");
        const checkboxes = document.querySelectorAll(".row-checkbox");
        const selectAll = document.getElementById("select-all");
    
        function updateDeleteButton() {
            deleteButton.disabled = !document.querySelector(".row-checkbox:checked");
        }
    
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", updateDeleteButton);
        });
    
        selectAll.addEventListener("change", function () {
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateDeleteButton();
        });
    
        deleteButton.addEventListener("click", function () {
            let selectedIds = Array.from(document.querySelectorAll(".row-checkbox:checked"))
                                  .map(cb => cb.closest("tr").getAttribute("data-id"));
    
            if (selectedIds.length === 0) return;

            let formData = new FormData();
            formData.append("ids", selectedIds.join(','));
    
            fetch("{% url 'delete_selected_products' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            }).then(response => response.text())
              .then(data => {
                  if (data === "success") {
                      selectedIds.forEach(id => {
                          document.querySelector(`tr[data-id='${id}']`).remove();
                      });
                      deleteButton.disabled = true;
                  } else {
                      alert("Błąd podczas usuwania!");
                  }
              });
        });
    });
    </script>
</html>